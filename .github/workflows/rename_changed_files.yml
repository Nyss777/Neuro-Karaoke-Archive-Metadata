name: Auto-Rename HJSON Metadata

on:
  workflow_call: # This makes it reusable  
  workflow_dispatch: # Allow manual trigger from the Actions tab

jobs:
  rename-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history so git mv detection works better

      # 1. Setup uv (Since you have uv.lock)
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # 2. Setup Python using the version in your pyproject.toml
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      # 3. Install dependencies from your lockfile
      - name: Install dependencies
        run: uv sync --all-extras --dev

      # 4. Run your Python script
      # We use 'find' to locate all HJSON files and pass them to the script via xargs.
      # PYTHONPATH=src ensures your 'metadata_utils' import works.
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: "**/*.hjson" # Only look for .hjson files

      - name: Run Rename Script
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          # Pass the space-separated list of changed files to your script
          uv run python .github/scripts/renaming_script.py ${{ steps.changed-files.outputs.all_changed_files }}

      # 5. Commit and Push changes if files were renamed
      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all changes (including renames)
          git add -A
          
          # Check if there are actually changes to commit
          if git diff --staged --quiet; then
            echo "No file renames detected."
          else
            echo "Committing renames..."
            # [skip ci] prevents this commit from triggering the workflow again (infinite loop protection)
            git commit -m "Auto-rename HJSON files to match tags [skip ci]"
            git push
          fi